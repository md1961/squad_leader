<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>SVG Background Image</title>

        <style>
            body {
                margin: 50px;
            }
            text {
                background-color: white;
            }
            .foreign-content {
                color: white;
                background-color: darkgreen;
                font-size: 10px;
                padding: 3px 3px;
            }
        </style>

        <script src="js/init.js" /></script>

        <script src="js/svg_element.js"></script>
        <script src="js/svg_util.js"></script>

        <script src="js/find_hex_from_coord.js" /></script>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const svg = document.getElementById("map");

                let hexName0, hexName1;
                let svgHex0;
                let isDragging = false;

                svg.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    hexName1 = null;

                    const [x, y] = transformViewPortCoordToSVG(e.clientX, e.clientY, svg);

                    hexName0 = findHexFromCoord(x, y);
                    if (hexName0) {
                        const [cx, cy] = coord(hexName0);
                        const elemHex = new SvgHex(cx, cy, rowHeight, {stroke: 'cyan', 'stroke-width': 3});
                        svgHex0 = elemHex.toDOM();
                        svg.appendChild(svgHex0);
                    }

                    //console.log(`hexName0 = ${findHexFromCoord(x, y)}`);
                });

                svg.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const [x, y] = transformViewPortCoordToSVG(e.clientX, e.clientY, svg);
                    hexName1 = findHexFromCoord(x, y);

                    if (hexName1 && hexName1 != hexName0) {
                        let lastChild;
                        while ((lastChild = svg.lastChild) !== svgHex0) {
                            svg.removeChild(lastChild);
                        }

                        const [cx, cy] = coord(hexName1);
                        const elemHex = new SvgHex(cx, cy, rowHeight, {stroke: 'red', 'stroke-width': 3});
                        svg.appendChild(elemHex.toDOM());
                    }
                });

                svg.addEventListener('mouseup', (e) => {
                    isDragging = false;

                    let lastChild;
                    while ((lastChild = svg.lastChild) !== svgHex0) {
                        svg.removeChild(lastChild);
                    }
                    svg.removeChild(lastChild);

                    if (hexName1) {
                        const [x1, y1] = coord(hexName0);
                        const [x2, y2] = coord(hexName1);
                        const elemLine = new SvgElement('line', {x1, y1, x2, y2, stroke: 'red', class: 'linfOfFire'});
                        svg.appendChild(elemLine.toDOM());

                        hexName1 = null;
                    } else {
                        const elemLinfOfFire = document.querySelector('.linfOfFire');
                        if (elemLinfOfFire) {
                            elemLinfOfFire.remove();
                        }
                    }
                });
            });
        </script>
    </head>

    <body>
        <svg id="map" width="938" height="645" xmlns="http://www.w3.org/2000/svg">
            <image
                href="map001.png"
                x="0" y="0"
                width="938" height="645"
                preserveAspectRatio="none" />

            <foreignObject x="330" y="165" width="80" height="50">
                <div xmlns="http://www.w3.org/1999/xhtml">
                    <span id="mySpan" class="foreign-content">
                        6-2-8:3
                    </span>
                </div>
            </foreignObject>

            <!-- Rectangle, to anchor coordinate system -->
            <rect
                x="57" y="65" width="843" height="548"
                fill="rgba(0, 0, 255, 0)" stroke="black" stroke-width="0" />
        </svg>
    </body>
</html>
